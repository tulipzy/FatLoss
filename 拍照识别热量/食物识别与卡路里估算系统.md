
# 食物识别与卡路里估算系统

本项目是一个基于 Food101 数据集的后端模块，结合图像分类模型、深度估计模型（MiDaS）、手掌比例测量等手段，实现对菜品的识别、体积估算及热量计算。适用于营养评估、饮食监控、健康饮食系统等应用场景。

---

##  项目结构

```
food101_backend/
│
├── dpt_cache/                      # MiDaS 深度模型缓存目录
├── model/                          # 模型结构定义文件夹
├── dish_calorie_name.py            # 菜品名称查询热量模块
├── dish_weight_calorie.py          # 由体积估算重量并计算热量
├── midas_model.py                  # 加载和使用 MiDaS 深度估计模型
├── volume.py                       # 基于深度与手掌比例的食物体积估算
│
├── requirements.txt                # Python依赖包列表
└── README.md                       # 当前文档
```

---

##  安装与环境配置

###  创建虚拟环境（可选）

```bash
python -m venv venv
venv\Scripts\activate
```

###  安装依赖

```bash
pip install -r requirements.txt
```

#### `requirements.txt` 示例内容：

```txt
fastapi
uvicorn
opencv-python
numpy
torch
transformers
mediapipe
Pillow
requests
fuzzywuzzy
python-multipart
sqlalchemy
pymysql
jieba
```

---

## 模块功能说明

| 文件 | 功能 |
|------|------|
| `volume.py` | 通过图像中的手掌比例和深度图，估算食物体积 |
| `midas_model.py` | 使用 MiDaS 模型进行深度图估计（支持 DPT-Large） |
| `dish_calorie_name.py` | 输入菜名，模糊查询热量值（Kcal/100g） |
| `dish_weight_calorie.py` | 将体积转换为重量，再结合热量计算总 Kcal |



---

## 体积与热量估算逻辑

1. **深度估计**：使用 MiDaS 模型预测深度图（midas_model.py）
2. **手掌测量**：通过手掌像素长度与实际厘米换算比例
3. **GrabCut 分割**：提取食物区域（可在 volume.py 中自定义）
4. **体积计算**：计算食物区域体积（cm³）
5. **密度估算**：通过菜品类型或经验值估算密度
6. **热量估算**：使用查表结果（或数据库）计算热量（Kcal）

## API接口

**拍照识别卡路里（可以百度API识别）：**

**成功**

```
{
  "success": true,
  "code": 200,
  "message": "成功",
  "data": {
    "items": [
      {
        "name": "红烧肉",
        "intro": "体积：230.22 cm³，密度：1.0 g/cm³，重量：230.22 g，总卡路里：522.6 kcal",
        "volume_cm3": 230.2,
        "density": 1.0,
        "weight_g": 230.2,
        "kcal_per100g": 227.0,
        "total_kcal": 522.6,
        "hand_removed_image_path": "hand_removed_images/baidu_20250725_202125.jpg"
      }
    ]
  }
}
```

**失败**

```
{
    "success": false,
    "code": 400,
    "message": "菜品识别失败，请检查图片：hand_removed_images/baidu_20250725_202634.jpg"
}
```

**菜名识别卡路里（百度API识别不到，根据菜名）：**

**成功**

```json
{
  "success": true,
  "code": 200,
  "message": "卡路里计算成功",
  "data": {
    "dish_name": "辣椒炒蛋",
    "dish_type": "bowl",
    "hand_length_cm": 18.0,
    "volume_cm3": 449.3,
    "density_g_cm3": 0.85,
    "weight_g": 381.9,
    "kcal_per100g": 160.0,
    "total_kcal": 611.0,
    "processed_image_path": "hand_removed_images/processed_20250730_084349.jpg"
  }
}
```

**失败**

```
{
    "success": false,
    "code": 404,
    "message": "未找到 '炒胡萝卜' 的信息，请重新输入或通过 /api/add_dish 接口添加",
    "data": null
}
```

**没找到菜品卡路里，添加菜品**

```json
{
  "success": true,
  "code": 200,
  "message": "食物 '大米粥' 已成功添加",
  "data": {
    "dish_name": "大米粥",
    "kcal_per100g": 88.0
  }
}
```

##  HTTP 标准状态码：

- 200：成功
- 400：参数错误
- 404：资源不存在（食物未找到）
- 409：资源冲突（添加重复食物）
- 500：服务器内部错误
- 503：外部服务调用失败
